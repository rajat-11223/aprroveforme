<%= form_for @approval do |f| %>
  <div class="grid-x grid-margin-x">
    <div class="large-8 large-offset-2 item-approval-form cell">
      <div class="grid-x">
        <div class="large-offset-1 large-2 small-3 cell">
          <p class="form-label">File*</p>
        </div>
        <div class="large-4 small-4 cell">
          <a id="file-selector" onclick="createPicker()" class="button primary" style="width:100%;">Select File</a>
        </div>
        <div class="large-offset-1 large-4 small-5 cell">
          <p class="form-file-name">
            <div id="result">
              <%= f.hidden_field :link if @approval.link %>
              <%= f.hidden_field :embed if @approval.embed %>
              <%= f.hidden_field :link_title if @approval.link_title %>
              <%= f.hidden_field :link_id if @approval.link_id %>
              <%= f.hidden_field :link_type if @approval.link_type %>
              <%= (link_to @approval.link_title, @approval.link ) if @approval.link_title %>
            </div>
          </p>
        </div>
        <label class="error"><%= error_message_on @approval, :link %></label>
      </div>
      <div class="grid-x">
        <div class="large-8 large-offset-3 small-12 cell">
          <label for="perms" style="margin-top:-18px;">
            <%= check_box("approval", "perms", {}, "writer", "reader") %>
            Allow reviewers to edit this document.</label>
        </div>
      </div>
      <div class="grid-x">
        <div class="large-offset-1 large-2 small-3 cell">
          <p class="form-label">Title*</p>
        </div>
        <div class="large-8 small-9 cell">
          <%= f.text_field :title, :placeholder => "Title", :id=>"result2" %>
        </div>
      </div>
      <div class="grid-x">
        <div class="large-offset-1 large-2 small-3 cell">
          <p class="form-label">Description</p>
        </div>
        <div class="large-8 small-9 cell">
          <%= f.text_area :description, placeholder: "Description", rows: 3 %>
        </div>
      </div>
      <div class="grid-x">
        <div class="large-offset-1 large-2 small-3 cell">
          <p class="form-label">Deadline*</p>
        </div>
        <div class="large-8 small-9 cell">
          <%= f.text_field :deadline, placeholder: "MM/DD/YYYY", id: "datepicker", value: (@approval.deadline.strftime("%m/%d/%Y") if @approval.deadline), as: :string %>
        </div>
      </div>
      <div class="grid-x">
        <div class="large-offset-1 large-2 small-12 cell">
          <p class="form-label">Approvers*</p>
        </div>
        <div class="large-8 small-12 cell">
          <div class="grid-x grid-margin-x">
            <label class="error"><%= error_message_on @approval, :approvers %></label>
            <div class="large-3 small-3 cell">
              <p class="form-label-approvers">Name</p>
            </div>
            <div class="large-6 small-6 cell">
              <p class="form-label-approvers">Email Address</p>
            </div>
            <div class="large-3 small-3 cell">
              <p class="form-label-approvers">Type</p>
            </div>
          </div>
          <%= f.fields_for :approvers do |builder| %>
          <%= render 'approver_form', :f => builder %>
        <% end %>
        <div class="add"></div>
        <div class="grid-x">
          <div class="large-12 cell">
            <%= button_to_add_fields('Add Another Approver', f, :approvers ) %>
          </div>
        </div>

      </div>
    </div>
    <div class="grid-x">
      <div class="large-10 large-offset-3  cell">
        <%= f.submit "Submit Document for Approval", :class => "button primary", :id =>"submit-approval" %>
      </div>
    </div>
  </div>
  </div>

<% end %>

<!-- The standard Google Loader script. -->
<script src="http://www.google.com/jsapi"></script>
<script type="text/javascript">
  // Use the Google Loader script to load the google.picker script. google.setOnLoadCallback(createPicker);
  google.load('picker', '1');

  // Create and render a Picker object
  function createPicker() {
    var view = new google.picker.DocsView(google.picker.ViewId.DOCS);
    view.setMode(google.picker.DocsViewMode.LIST);
    var picker = new google.picker.PickerBuilder().setAppId("<%= ENV['APP_ID']%>").setOAuthToken("<%= current_user.token %>").addView(view).addView(new google.picker.DocsUploadView()).setCallback(pickerCallback).build();
    picker.setVisible(true);
  }

  // A simple callback implementation.
  function pickerCallback(data) {
    var url = 'nothing';

    if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
      var doc = data[google.picker.Response.DOCUMENTS][0];
      url = doc[google.picker.Document.URL];
      title = doc.name;
      id = doc.id;
      type = doc.type;
      embed = doc[google.picker.Document.EMBEDDABLE_URL];
    }

    var message = "<input id=\"approval_link\" name=\"approval[link]\" type=\"hidden\" value=\"" + url + "\">";
    message = message + "<input id=\"approval_embed\" name=\"approval[embed]\" type=\"hidden\" value=\"" + embed + "\">";
    message = message + "<input id=\"approval_link_title\" name=\"approval[link_title]\" type=\"hidden\" value=\"" + title + "\">";
    message = message + "<input id=\"approval_link_id\" name=\"approval[link_id]\" type=\"hidden\" value=\"" + id + "\">";
    message = message + "<input id=\"approval_link_type\" name=\"approval[link_type]\" type=\"hidden\" value=\"" + type + "\">";

    // add HTML around this for title
    message = message + "<p class=\"form-file-name\">Filename: " + title + "</p>"

    //message = message + title
    document.getElementById('result').innerHTML = message;
    document.getElementById('file-selector').text = "Replace File";

    //!-- if you want to prefill the title field with the doc title, uncomment below.
    var myTextField = document.getElementById('result2');
      myTextField.value = title;
    }

  function add_fields(link, association, content) {
    var new_id = new Date().getTime();
    var regexp = new RegExp("new_" + association, "g");
    //document.body.insertBefore(content.replace(regexp, new_id), $('div#insert'));
    $("div.add").before(content.replace(regexp, new_id));
    //$(link).before(content.replace(regexp, new_id));
  }
</script>
